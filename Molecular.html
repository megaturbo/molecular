<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="css/molecular.css">
    <script src="js/commonFunctions.js"></script>
    <script src="js/gl-matrix-min.js"></script>
    <script src="js/webglTools.js"></script>

    <script src="engine/utils.js"></script>
    <script src="engine/Renderer.js"></script>
    <script src="engine/Scene.js"></script>
    <script src="engine/molecular.js"></script>

    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;

		uniform vec3 uAtomPosition;
		uniform vec4 uAtomColor;
		uniform float uAtomRadius;
		uniform mat4 uMVMatrix;
		uniform mat4 uPMatrix;
        uniform vec3 uLightAmbient;
        uniform vec3 uMaterialDiffuse;
        uniform vec3 uMaterialSpecular;
        uniform vec3 uLightPosition;

        uniform bool uAtomExplode;

        varying vec3 vNormal;
        varying vec3 vEyeVec;
        varying vec3 vLightRay;

        void main(void) {
            vec4 vertex = uMVMatrix * vec4(aVertexPosition + uAtomPosition, 1.0);
            vNormal = aVertexPosition;

            vec4 light = vec4(uLightPosition, 1.0);
            vLightRay = vertex.xyz - light.xyz;
            vEyeVec = -vec3(vertex.xyz);

            float uAtomRadiusShow = uAtomRadius;
            if(uAtomExplode){
                uAtomRadiusShow = uAtomRadius * 0.2;
            }

		    vec4 transformedVertexPos = uMVMatrix * vec4(uAtomRadiusShow * aVertexPosition + uAtomPosition, 1.0);
			gl_Position = uPMatrix * transformedVertexPos;
		}

    </script>
    <script id="shader-fs" type="x-shader/x-fragment">
			#ifdef GL_ES
				precision highp float;
			#endif

            uniform float uShininess;
            uniform vec3 uLightAmbient;
            uniform vec3 uMaterialDiffuse;
            uniform vec3 uMaterialSpecular;
    		uniform vec4 uAtomColor;

            varying vec3 vNormal;
            varying vec3 vLightRay;
            varying vec3 vEyeVec;

			void main(void) {

                vec3 L = normalize(vLightRay);
                vec3 N = normalize(vNormal);

                float lambertTerm = dot(N, -L);
                // vec3 finalColor = uLightAmbient;
                vec3 finalColor = uAtomColor.xyz;

                if(lambertTerm > 0.0)
                {
                    finalColor += uMaterialDiffuse * lambertTerm;
                    vec3 E = normalize(vEyeVec);
                    vec3 R = reflect(L, N);
                    float specular = pow(max(dot(R, E), 0.0), uShininess);
                    finalColor += uMaterialSpecular * specular;
                }

		   		gl_FragColor = vec4(finalColor, 1.0);
			}

    </script>

    <script>
        // Camera movements
        var rotX = 0.0;
        var rotY = 0.0;
        var movX = 0.0;
        var movY = 0.0;
        var movZ = -5.0;

        var mvMatrix = mat4.create();
        var pMatrix = mat4.create();

        window.onkeydown = checkKey;
        function checkKey(ev) {
            switch (ev.keyCode) {
                case 65:
                    movX -= 0.2;
                    break;
                case 68:
                    movX += 0.2;
                    break;
                case 87:
                    movZ += 0.2;
                    break;
                case 83:
                    movZ -= 0.2;
                    break;
                default:
                    console.log(ev.keyCode);
                    break;
            }
        }

        function changeMolecule(){
            var index = document.getElementById("select_molecule").selectedIndex;
            setMolecule(index);
            document.getElementById("molecule_name").innerHTML = molecules[index].name;
        }

        /**
         * Called in Renderer.js
         * Used to init the <select> component with instanciated molecules
         */
        function initSelect()
        {
            var select = document.getElementById("select_molecule");

            for(var i = 0; i < molecules.length; i++)
            {
                var opt = document.createElement('option');
                opt.value = i;
                opt.innerHTML = molecules[i].name;
                select.appendChild(opt);
            }
        }

        function toggleExplode()
        {
            var btnExplode = document.getElementById("button_explode");
            var atomExplode = btnExplode.value;

            if(atomExplode == "0")
            {
                atomExplode = 1;
                btnExplode.innerHTML = "Explode<sup>-1</sup>";
            }
            else if(atomExplode == "1")
            {
                atomExplode = 0;
                btnExplode.innerHTML = "Explode";
            }

            glContext.uniform1i(prg.atomExplode, atomExplode);
            btnExplode.value = atomExplode;
        }


    </script>
</head>


<body onload="initWebGL()">
<header>
    <h1 id="header">molecular</h1>
    <p>© Roulin Thomas</p>
</header>
<div id="container">
    <div id="left-menu">
        <h3>Molecule displayed: <span id="molecule_name">Water (H2O)</span></h3>
        <div id="molecule-selector">
            <label for="select_molecule">Choose your molecule</label>

            <select name="select_molecule" id="select_molecule" onchange="changeMolecule()">
            </select>
        </div>
        <label for="button_explode">Explode ?</label>
        <button type="button" id="button_explode" value="0" onclick="toggleExplode()">Explode</button>
    </div>
    <div id="center">
        <canvas id="webgl-canvas" width=700 height=700>
            HTML5 is not supported
        </canvas>
    </div>
    <div id="right-menu">
        <p class="info">
            You can use <i>W,A,S,D</i>  to move the molecule and your mouse to rotate it.
        </p>
    </div>
</div>
</body>
    <script src='js/mouseMotionHandling.js'></script>
</html>
