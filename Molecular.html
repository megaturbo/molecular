<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="css/molecular.css">
    <script src="js/commonFunctions.js"></script>
    <script src="js/gl-matrix-min.js"></script>
    <script src="js/webglTools.js"></script>

    <script src="o/utils.js"></script>
    <script src="o/molecular.js"></script>

    <script id="shader-vs" type="x-shader/x-vertex">
			attribute vec3 aVertexPosition;
			attribute vec4 aColor;

			uniform vec3 uAtomPosition;
			uniform vec4 uAtomColor;

		    uniform mat4 uMVMatrix;
		    uniform mat4 uPMatrix;
			varying vec4 vColor;
		    void main(void) {
		        vec4 transformedVertexPos = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
				gl_Position = transformedVertexPos;
				vColor = aColor;
			}

    </script>
    <script id="shader-fs" type="x-shader/x-fragment">
			#ifdef GL_ES
				precision highp float;
			#endif
			varying vec4 vColor;
			void main(void) {
		   		gl_FragColor = vColor;
			}

    </script>

    <script>

        var molecules = [];

        function createScene() {
            // Creating a molecule
            var white = new Color(1.0, 1.0, 1.0, 1.0);
            var red = new Color(1.0, 0.0, 0.0, 1.0);

            var atoms = [
                new Atom("H", white, 0.2, new Point3d(-0.76537, 0.0, 0.19508)),
                new Atom("H", white, 0.2, new Point3d(0.76357, 0.0, 0.19508)),
                new Atom("O", red, 0.35, new Point3d(0.0, 0.7, -0.39016))
            ];

            var links = [
                new Link(atoms[0], atoms[2]),
                new Link(atoms[1], atoms[2])
            ];

            molecules.push(new Molecule("Water (H2O)", atoms, links));
        }

        // Camera movements
        var rotX = 0.0;
        var rotY = 0.0;
        var movX = 0.0;
        var movY = 0.0;
        var movZ = -5.0;

        var mvMatrix = mat4.create();
        var pMatrix = mat4.create();

        window.onkeydown = checkKey;
        function checkKey(ev) {
            switch (ev.keyCode) {
                case 65:
                    movX -= 0.5;
                    break;
                case 68:
                    movX += 0.5;
                    break;
                case 87:
                    movZ += 0.5;
                    break;
                case 83:
                    movZ -= 0.5;
                    break;
                default:
                    console.log(ev.keyCode);
                    break;
            }
        }

        function initShaderParameters(prg) {
            prg.vertexPositionAttribute = glContext.getAttribLocation(prg, "aVertexPosition");
            glContext.enableVertexAttribArray(prg.vertexPositionAttribute);
            prg.colorAttribute = glContext.getAttribLocation(prg, "aColor");
            glContext.enableVertexAttribArray(prg.colorAttribute);

            prg.pMatrixUniform = glContext.getUniformLocation(prg, 'uPMatrix');
            prg.mvMatrixUniform = glContext.getUniformLocation(prg, 'uMVMatrix');

            prg.atomPositionUniform = glContext.getUniformLocation(prg, "uAtomPosition");
            prg.atomColorUniform = glContext.getUniformLocation(prg, "uAtomColor");
        }


        function initBuffers() {
            //TODO delete or use it
        }

        function drawScene() {
            glContext.clearColor(0.9, 0.9, 1.0, 1.0);
            glContext.enable(glContext.DEPTH_TEST);
            glContext.clear(glContext.COLOR_BUFFER_BIT | glContext.DEPTH_BUFFER_BIT);
            glContext.viewport(0, 0, c_width, c_height);
            mat4.perspective(pMatrix, degToRad(60), c_width / c_height, 0.1, 10000.0);

            translationMat = mat4.create();
            mat4.identity(translationMat);
            mat4.translate(translationMat, translationMat, [movX, movY, movZ]);
            mvtMatrix = mat4.create();
            mat4.multiply(mvtMatrix, translationMat, mvMatrix);

            rotateModelViewMatrixUsingQuaternion();

            glContext.uniformMatrix4fv(prg.pMatrixUniform, false, pMatrix);
            glContext.uniformMatrix4fv(prg.mvMatrixUniform, false, mvtMatrix);

            // Draw those molecules
            molecules.forEach(function (molecule) {
                molecule.draw(glContext);
            });

            // Nice
            rotY = 0;
            rotX = 0;
        }
        function initWebGL() {
            glContext = getGLContext('webgl-canvas');
            initProgram();
//            initBuffers();
            createScene();
            renderLoop();
        }
    </script>
</head>


<body onload="initWebGL()">
<header>
    <h1>molecular</h1>

    <p>Â© Roulin Thomas</p>
</header>

<div id="container">
    <div>
        <p>Molecule</p>
        <label for="select_molecule">Choose your molecule</label>
        <select name="select_molecule" id="select_molecule">
            <option value="0">Eau (H2O)</option>
            <option value="1">Lol</option>
            <option value="2">Test</option>
        </select>
    </div>
    <br>
    <canvas id="webgl-canvas" width=700" height="700">
        HTML5 is not supported
    </canvas>
</div>
</body>
<script src='js/mouseMotionHandling.js'></script>
</html>